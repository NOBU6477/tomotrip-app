# 回帰テスト（検索 × ページ × 再検索 × 登録・認証）

> **更新履歴**: 
> - 2026-01-20 シナリオJ-2（予約導線完全確認）、シナリオK-2（一覧-詳細間バッジ一致確認）を追加
> - 2026-01-20 シナリオJ（予約導線）、シナリオK（延長バッジ反映）を追加
> - 2026-01-20 シナリオH/I（延長リクエスト機能）を追加
> - 2026-01-19 シナリオD/E/F/G（登録・認証・画像アップロード系）を追加

このドキュメントは、検索・ページネーション・詳細遷移に関する
過去の不具合（検索リセット、ページズレ、重複表示など）が
再発していないことを確認するための必須テスト手順である。

リリース前、仕様変更後、検索関連の修正後は必ず実施すること。

================================
■ シナリオA
検索 → ページ移動 → 詳細 → 戻る（検索状態復元）
================================

目的：
検索条件・ページ番号・スクロール位置が
「詳細→戻る」で正しく復元されることを確認する。

手順：
1. ガイド一覧ページを開く
2. 条件を設定する
   - 地域：例）東京都
   - 言語：例）英語
   - 価格・キーワード：任意
3. 検索を実行
4. 結果一覧が表示されることを確認
5. 次のページへ移動（2ページ目）
6. 任意のガイドで「詳細を見る」を押す
7. 詳細ページが表示されることを確認
8. 戻る（ボタンまたはブラウザ戻る）を押す

合格条件（PASS）：
- 検索条件が維持されている
- ページ番号が維持されている
- 表示結果が検索条件と一致している
- デフォルト状態に戻らない

================================
■ シナリオB
検索 → 30秒更新 → 状態維持
================================

目的：
30秒自動更新によって検索結果やページ状態が
壊れないことを確認する。

手順：
1. 条件を設定して検索
2. 次のページへ移動（2ページ目）
3. そのまま40秒待つ（自動更新を跨ぐ）
4. 表示状態を確認する

合格条件（PASS）：
- 検索条件が維持されている
- ページ番号が変わらない
- 重複表示や別条件の混入が起きない
- 操作不能にならない

================================
■ シナリオC
検索 → ページ移動 → 条件変更して再検索
================================

目的：
再検索時に古い検索結果やページ状態が
正しくリセットされることを確認する。

手順：
1. 条件①で検索（例：東京都 × 英語）
2. 次のページへ移動
3. 条件②に変更（例：東京都 × 日本語）
4. 検索を再実行
5. 表示結果を確認
6. 必要であれば次のページへ移動
7. 条件③に変更して再検索

合格条件（PASS）：
- 再検索後は必ず1ページ目から表示される
- 表示結果が新しい条件に完全一致する
- 古い条件の結果が混ざらない
- 件数表示とカード数が一致する

================================
■ スマホ簡易チェック（必須）
================================

- シナリオAの「詳細 → 戻る」をスマホで1回実施
- 戻ったときに検索状態が維持されていることを確認

================================
■ 実施タイミング
================================

- 本番リリース前
- 検索・ページネーション・詳細遷移の修正後
- ガイドデータ構造変更後

================================
■ デバッグモード
================================

TT-DEBUG モードを有効にして詳細ログを確認する場合：
1. ブラウザのコンソールで `window.__TT_DEBUG = true` を入力
2. ページをリロード
3. 操作を行い、コンソールログを確認

デバッグモードでは以下が出力される:
- `[TT-DEBUG] context=...` - ページネーション状態の詳細
- `✅` - 正常（重複なし、カウンター整合）
- `❌` - エラー（重複あり、カウンター不整合、フィルタ違反）

通常モードではデバッグログは出力されない（本番影響なし）。

================================
■ シナリオD
未登録 → 詳細 → 登録 → 完了 → 元の詳細へ戻る
================================

目的：
未登録ユーザーが詳細導線から登録しても、完了後に「元の目的地」に戻れることを確認する。

手順：
- [ ] 一覧で検索条件を設定して検索（地域/言語/価格/キーワードのうち2つ以上）
- [ ] いずれかのガイドで「詳細を見る」を押す
- [ ] 登録促しページへ遷移することを確認
- [ ] 観光客登録を実行（身分証＋顔写真アップロード含む）
- [ ] 登録完了後に「元の詳細」または「元の検索結果（詳細直前の状態）」に戻ることを確認

合格条件（PASS）：
- [ ] 登録完了後にトップ初期状態へ飛ばない
- [ ] 直前の目的地（詳細/検索結果）が復元される
- [ ] 画面が真っ白/無限ロードにならない

================================
■ シナリオE（最重要）
登録済み → 詳細 → 戻る → 再登録要求されない
================================

目的：
登録済みユーザーに対して「再度登録を求める」不具合が出ないことを確認する（スマホ優先）。

手順：
- [ ] 一度「登録完了」状態の端末でテストする（同一端末/同一ブラウザ）
- [ ] 一覧で検索 → 「詳細を見る」→ 戻る
- [ ] 別のガイドでも「詳細を見る」→ 戻る
- [ ] ブラウザを更新（リロード）してから同じ操作を繰り返す

合格条件（PASS）：
- [ ] どの操作でも登録画面へ飛ばされない（登録済みとして扱われる）
- [ ] リロード後も登録済み判定が維持される
- [ ] PC/スマホで挙動が一致する

================================
■ シナリオF
スマホ画像アップロード（身分証・顔写真）
================================

目的：
スマホ特有のアップロード失敗（選択できない/反映されない/送信できない）を検出する。

手順（スマホ）：
- [ ] 観光客登録ページを開く
- [ ] 身分証のアップロード欄をタップして写真を選択できる
- [ ] 顔写真のアップロード欄をタップして写真を選択できる
- [ ] 送信して登録完了まで進める
- [ ] 登録後に再アクセスしても登録要求されないことを確認（シナリオEと連動）

合格条件（PASS）：
- [ ] 画像選択が毎回成功する（タップ無反応がない）
- [ ] 送信時にサーバーエラーにならない
- [ ] 登録後に再登録要求が出ない

================================
■ シナリオG（デバッグ確認・任意）
登録状態の判定ログを確認
================================

目的：
登録判定がどこで true/false になっているか追える状態になっているか確認する。

手順：
- [ ] ブラウザコンソールで `window.__TT_DEBUG = true` を入力
- [ ] ページをリロード
- [ ] 詳細を見る → 登録誘導/登録済み判定 → 戻る を実施
- [ ] `[TT-DEBUG]` プレフィックス等で「認証/登録状態」「returnTo」「保存/復元」のログが確認できる

合格条件（PASS）：
- [ ] 登録済み時に「registered=true」相当が確認できる
- [ ] returnTo の保存/復元がログで追える
- [ ] エラーが赤ログで出ていない

================================
■ シナリオH
延長リクエスト → 承認 → 状態反映
================================

目的：
観光客が延長リクエストを送信し、ガイドが承認した場合に双方に正しく反映されることを確認する。

手順：
- [ ] 予約詳細画面（/reservation-detail.html?id=予約ID）を開く
- [ ] 「延長を相談する」ボタンを押す
- [ ] 30分を選択して「ガイドに相談を送る」を押す
- [ ] ガイドダッシュボード（/guide-dashboard.html?id=ガイドID）を開く
- [ ] 延長リクエスト欄にpending状態のリクエストが表示されることを確認
- [ ] 「承認」ボタンを押す
- [ ] 予約詳細画面で「延長リクエスト履歴」を確認し、approved状態になっていることを確認

合格条件（PASS）：
- [ ] リクエスト送信後にガイド側に表示される
- [ ] 承認後に観光客側で承認状態が確認できる
- [ ] 料金が正しく表示される（30分=¥1,500）

================================
■ シナリオI
延長リクエスト → 拒否 → 状態反映
================================

目的：
ガイドが延長リクエストを拒否した場合に双方に正しく反映されることを確認する。

手順：
- [ ] 予約詳細画面で「延長を相談する」→ 120分を選択して送信
- [ ] ガイドダッシュボードで「断る」ボタンを押す
- [ ] 予約詳細画面で「延長リクエスト履歴」を確認し、rejected状態になっていることを確認

合格条件（PASS）：
- [ ] 拒否後に観光客側で拒否状態が確認できる
- [ ] ガイド側で履歴として表示される
- [ ] 同じリクエストを再度承認/拒否できない（処理済みエラー）

================================
■ シナリオJ
ガイド詳細 → 予約する → 予約画面表示
================================

目的：
観光客がガイド詳細から予約画面に正しく遷移できることを確認する。

手順：
- [ ] ガイド一覧から任意のガイドで「詳細を見る」を押す
- [ ] ガイド詳細画面が表示される
- [ ] 「予約する」ボタンを押す
- [ ] 予約詳細画面（/reservation-detail.html?guideId=...）に遷移する
- [ ] 予約フォームが表示される（お名前、日時、人数など）
- [ ] 戻るボタンでガイド一覧に戻れる

合格条件（PASS）：
- [ ] 「予約する」でアラートが出ない（開発中表示が出ない）
- [ ] 予約フォームが正しく表示される
- [ ] ガイド情報が予約画面右側に表示される
- [ ] 戻った時に検索状態が保持されている

================================
■ シナリオK
延長バッジが登録内容と一致する
================================

目的：
ガイド登録で選択した延長対応が、ガイドカードのバッジに正しく反映されることを確認する。

手順：
- [ ] ガイド登録画面で「延長対応：延長可能（OK）」を選択して登録
- [ ] ガイド一覧でそのガイドのカードを確認
- [ ] バッジが「延長OK」になっていることを確認
- [ ] 別のガイドで「延長対応：延長不可」を選択して登録
- [ ] バッジが「延長不可」になっていることを確認

合格条件（PASS）：
- [ ] 延長OK選択 → カードに「延長OK」バッジ（水色）
- [ ] 要相談選択 → カードに「延長:要相談」バッジ（黄色）
- [ ] 延長不可選択 → カードに「延長不可」バッジ（グレー）
- [ ] 既存ガイド（フィールドなし）は「延長:要相談」がデフォルト

================================
■ シナリオJ-2
予約導線の完全確認
================================

目的：
どの環境（replit.app / replit.dev）でも「予約する」ボタンが
アラートを出さずに予約フォームへ遷移することを確認する。

手順：
- [ ] ガイド一覧から任意のガイドで「詳細を見る」を押す
- [ ] ガイド詳細画面の「予約する」ボタンを押す
- [ ] alert が表示されないことを確認（「開発中」等）
- [ ] reservation-detail.html?guideId=... に遷移することを確認
- [ ] 予約フォームにガイド情報が表示されることを確認

合格条件（PASS）：
- [ ] 「予約する」押下時にアラートが出ない
- [ ] reservation-detail.html に正しく遷移
- [ ] ガイド情報（名前、料金、延長対応）が表示される
- [ ] replit.app と replit.dev の両方で同じ動作

================================
■ シナリオK-2
一覧カードと予約詳細の延長バッジ一致確認
================================

目的：
ガイド一覧カードの延長バッジと、予約詳細ページのガイド情報欄の
延長バッジが一致することを確認する。

手順：
- [ ] ガイド一覧で特定ガイドの延長バッジを確認（例：「延長OK」）
- [ ] そのガイドの「詳細を見る」→「予約する」を押す
- [ ] 予約詳細ページ右側のガイド情報欄の延長バッジを確認
- [ ] 一覧と詳細で同じバッジ表示であることを確認

合格条件（PASS）：
- [ ] 一覧カードが「延長OK」→ 予約詳細も「延長OK」
- [ ] 一覧カードが「延長:要相談」→ 予約詳細も「延長:要相談」
- [ ] 一覧カードが「延長不可」→ 予約詳細も「延長不可」
- [ ] 不一致が発生しない

不具合発生時の原因切り分け：
1. APIレスポンスに extensionPolicy が含まれているか確認
2. フロントエンドのデータ変換で extensionPolicy が保持されているか確認
3. 一覧と詳細で異なるAPIエンドポイントを使用している場合、両方で同じ値を返すか確認

================================
■ 補足
================================

- 本テストは「人が見て判断できる」ことを重視する。
- 検索系修正後は必ずこのドキュメントを確認すること。
- 登録・認証系の修正後はシナリオD/E/F/Gを優先して確認すること。
- 延長機能の修正後はシナリオH/I/J/Kを優先して確認すること。
- 予約導線の修正後はシナリオJを優先して確認すること。
