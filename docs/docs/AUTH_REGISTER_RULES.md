# 認証・登録フロー 設計ルール（1枚）
TomoTrip / CenterDisplay 用

目的：
- 「登録できたのにまた登録を求められる」「スマホだけ挙動が違う」などの事故を防ぐ
- 画面遷移・ログイン状態・登録状態の責任範囲を固定する（再発防止）

---

## ルール1：状態は「3種類」に分けて扱う（混ぜない）
この3つを別物として管理する。

1) 認証状態（Auth）
- ログインしているか（token / session）
- 例：isAuthenticated / accessToken

2) 登録状態（Profile / Registration）
- 登録フォームが完了しているか
- 例：isRegistered / profileCompleted

3) 画面状態（UI / Navigation）
- 検索条件、ページ番号、どこから来たか
- 例：returnTo / lastSearchState

✅ OK：
- Auth が true でも Registration が false なら「登録画面へ誘導」
- Registration が true なら「登録を再要求しない」

❌ NG：
- 認証できてるのに「登録済み判定」が消えて再登録要求
- UI状態の初期化で「登録状態」まで巻き込む

---

## ルール2：「登録済み判定」は1つのソースを正にする（Single Source of Truth）
登録済みかどうかは “毎回推測しない”。

✅ 推奨：
- サーバー（DB）に `profileCompleted` 等のフラグ
- クライアント側は「キャッシュ」扱いにする

❌ NG：
- localStorage の有無だけで登録済み判定
- 画面遷移のたびにバラバラの判定ロジック（ページごとに違う）

---

## ルール3：登録後のリダイレクトは「戻り先を保持」して必ず復元
登録導線は「途中で別ページへ飛ぶ」ことが多いので、戻り先を必ず保存する。

✅ OK（推奨の流れ）：
1. 詳細/予約/チャット押下
2. 未登録なら、現在のURL/状態を保存（returnTo）
3. 登録完了後、returnTo に戻す
4. returnTo が無い時だけトップへ

❌ NG：
- 登録完了後に必ずトップへ戻す
- 戻る先が消えて、ユーザーが再検索を強いられる

---

## ルール4：スマホの画像アップロードは「ブラウザ差」を前提に作る
スマホは “同じHTML” でも挙動が違うことがある。

✅ 必須チェック：
- input type="file" がクリック/タップで反応する
- accept="image/*" が設定されている
- iPhone向け：capture は必須ではない（むしろ邪魔な場合あり）
- 送信前にファイルサイズ/形式をチェックして、エラーを画面に出す

❌ NG：
- PCだけで動作確認してリリース
- エラーを console だけに出してユーザーには無言

---

## ルール5：登録済みなのに再登録を求める不具合は「優先度S」
原因はたいていこのどれか。

- (A) 登録完了フラグが保存されていない（保存タイミング/失敗）
- (B) 保存はされているが、読み出しが遅くて未登録扱いになる（初期化競合）
- (C) ページ遷移で localStorage/sessionStorage が違うドメイン扱いになっている
- (D) Service Worker / Cache の古いJSが残り、判定ロジックが混在

✅ 対策の原則：
- 「登録完了イベント」→「永続保存」→「再読み込みしても成立」までを1セットで保証する

---

## ルール6：判定・遷移は「共通関数」に集約する（分散禁止）
登録・認証の判定がページごとに散らばると、スマホだけ壊れる。

✅ OK：
- requireAuth()
- requireRegistration()
- getRegistrationStatus()
- redirectAfterRegistration()

❌ NG：
- guide-detail.html だけ独自判定
- tourist登録ページだけ独自判定
- index側と詳細側で条件が微妙に違う

---

## 実装の合格条件（PASS）
- 登録完了後、同じ端末で再アクセスしても登録を求められない
- 詳細 → 登録 → 完了 → 元の詳細/元の検索結果に戻れる
- スマホで画像アップロードが安定して成功する
- PC/スマホで判定ロジックが一致している（共通関数を通っている）

---

## 運用ルール（この1枚の使い方）
- 認証/登録の修正をするAgent作業の冒頭で必ず読む
- バグ報告が出たら、まずこのルールに違反してないか確認してからコード修正する
