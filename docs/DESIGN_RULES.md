# DESIGN_RULES_SEARCH_PAGINATION.md
（検索 × ページネーション × 詳細遷移 設計ルール）

このドキュメントは、
検索・ページネーション・詳細遷移まわりで
過去に発生した重大な不具合を二度と再発させないための
**設計ルール（破ってはいけない原則）**をまとめたものである。

実装変更・機能追加・最適化を行う際は、
必ずこのルールに反していないか確認すること。

---

## ルール①
### 検索結果の「正」は常に1か所だけに持つ

❌ NG：
- 検索結果を複数の配列でバラバラに管理する
- ページネーション用・フィルタ用で別の配列を持つ

✅ OK：
- 検索後の結果は **state.filteredGuides のみ**
- ページネーション・描画・カウンターはすべてここを参照する

理由：
> 複数の「正」が存在すると、  
> ページ移動・再検索・30秒更新時に必ずズレる

---

## ルール②
### ページネーションは「描画ロジック」を持たない

❌ NG：
- ページネーション側で配列を slice する
- ページネーションが DOM を直接触る

✅ OK：
- ページネーションは「何ページ目か」だけを管理
- 実際の描画は **renderFilteredGuides() に一本化**

理由：
> ページネーションが賢くなるほど  
> 検索との整合性が壊れる

---

## ルール③
### 再検索時は必ず「1ページ目」に戻す

❌ NG：
- 検索条件を変えても現在ページを維持する
- 状態を部分的にリセットする

✅ OK：
- 検索条件が1つでも変わったら
  - page = 1
  - filteredGuides を再生成
  - そこから描画

理由：
> 再検索でページを維持すると  
> 「表示はあるのに存在しない」状態が生まれる

---

## ルール④
### 詳細遷移前に「検索状態を必ず保存」する

保存対象：
- 検索条件（地域・言語・価格・キーワード）
- 現在ページ
- スクロール位置

保存先：
- sessionStorage
- URLクエリ（可能なもの）

復元タイミング：
- 一覧ページ初期化時
- 30秒自動更新後

理由：
> 「戻る」で検索状態が消えるUXは  
> 実利用では致命的ストレスになる

---

## ルール⑤
### 30秒更新は「データだけ」更新する

❌ NG：
- 30秒更新で検索条件・ページを初期化
- 強制的に再描画して状態を壊す

✅ OK：
- データ更新後は
  - 現在の検索条件を再適用
  - ページ状態を維持
  - filteredGuides を再生成

理由：
> 自動更新は「裏側の更新」であり  
> 画面状態を変えてはいけない

---

## ルール⑥
### 描画関数は「状態を変更しない」

❌ NG：
- render 内で state を書き換える
- カウンター更新を render に混在させる

✅ OK：
- state変更 → 描画 の一方向
- renderFilteredGuides は表示専用

理由：
> 描画が副作用を持つと  
> デバッグ不能なバグになる

---

## ルール⑦
### 修正後は必ず REGRESSION_TEST.md を実施する

必須確認：
- シナリオA（検索 → 詳細 → 戻る）
- シナリオB（30秒更新）
- シナリオC（再検索）
- スマホ簡易チェック

理由：
> 過去に直ったと思った不具合は  
> すべて「テスト未固定」が原因

---

## このルールを破ってよいケース

- 検索・ページネーションの仕様を根本から変える場合
- SPA構成を全面刷新する場合

※ その場合は **本ドキュメント自体を更新すること**

---

## 最後に

このルールは
「きれいなコード」より  
「壊れないプロダクト」を優先するためのもの。

将来、
「なぜこんな実装？」と思ったら  
それは **過去のバグの墓標** である。
