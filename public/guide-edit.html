<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ã‚¤ãƒ‰æƒ…å ±ç·¨é›† - TomoTrip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .ocean-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .edit-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .section-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .section-header {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px 15px 0 0;
            margin: -1px -1px 0 -1px;
        }
        .rating-display {
            color: #ffc107;
        }
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin: 5px;
        }
        .language-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin: 2px;
            display: inline-block;
        }
        .specialty-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 3px;
            display: inline-block;
        }
        .edit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .save-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
    </style>
</head>
<body class="ocean-bg">
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-light" onclick="history.back()">
                <i class="bi bi-arrow-left me-2"></i>æˆ»ã‚‹
            </button>
            <h1 class="text-white mb-0">
                <i class="bi bi-person-gear me-2"></i>ã‚¬ã‚¤ãƒ‰æƒ…å ±ç·¨é›†
            </h1>
            <div></div>
        </div>

        <div class="edit-container p-4">
            <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-person-circle me-2"></i>åŸºæœ¬æƒ…å ±</h4>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="profile-photo-container mb-3">
                                <img id="profilePhotoPreview" src="/assets/images/default-guide.jpg" 
                                     class="rounded-circle border" width="120" height="120" 
                                     style="object-fit: cover;">
                                <div class="mt-2">
                                    <input type="file" id="profilePhotoInput" class="d-none" accept="image/*">
                                    <button class="btn btn-sm edit-btn" onclick="document.getElementById('profilePhotoInput').click()">
                                        <i class="bi bi-camera me-1"></i>å†™çœŸå¤‰æ›´
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ã‚¬ã‚¤ãƒ‰å</label>
                                    <input type="text" class="form-control" id="guideName" placeholder="ã‚¬ã‚¤ãƒ‰åã‚’å…¥åŠ›">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">æ–™é‡‘ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" id="dailyRate" placeholder="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">æ´»å‹•åœ°åŸŸ</label>
                                    <input type="text" class="form-control" id="location" placeholder="ä¾‹: äº¬éƒ½åºœ äº¬éƒ½å¸‚">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ã‚¬ã‚¤ãƒ‰ã‚¿ã‚¤ãƒ—</label>
                                    <select class="form-control" id="guideType">
                                        <option value="day">æ—¥å¸°ã‚Šã‚¬ã‚¤ãƒ‰</option>
                                        <option value="overnight">ä¸€æ³Šã‚¬ã‚¤ãƒ‰</option>
                                        <option value="multi-day">é•·æœŸã‚¬ã‚¤ãƒ‰</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">å¯¾å¿œè¨€èª</label>
                                <div id="languagesContainer">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_japanese" value="æ—¥æœ¬èª">
                                        <label class="form-check-label" for="lang_japanese">æ—¥æœ¬èª</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_english" value="è‹±èª">
                                        <label class="form-check-label" for="lang_english">è‹±èª</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_chinese" value="ä¸­å›½èª">
                                        <label class="form-check-label" for="lang_chinese">ä¸­å›½èª</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_korean" value="éŸ“å›½èª">
                                        <label class="form-check-label" for="lang_korean">éŸ“å›½èª</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang_taiwanese" value="å°æ¹¾èª">
                                        <label class="form-check-label" for="lang_taiwanese">å°æ¹¾èª</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è‡ªå·±ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-chat-text me-2"></i>ã‚¬ã‚¤ãƒ‰ã«ã¤ã„ã¦</h4>
                </div>
                <div class="p-3">
                    <textarea class="form-control" id="introduction" rows="4" 
                              placeholder="è‡ªå·±ç´¹ä»‹æ–‡ã‚’ã”è¨˜å…¥ãã ã•ã„ã€‚ãŠå®¢æ§˜ã«å¯¾ã™ã‚‹ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã‚„ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦ã®æƒ³ã„ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>

            <!-- çµŒé¨“ãƒ»å®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-award me-2"></i>çµŒé¨“ãƒ»å®Ÿç¸¾</h4>
                </div>
                <div class="p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ã‚¬ã‚¤ãƒ‰æ­´</label>
                            <select class="form-control" id="experience">
                                <option value="beginner">åˆå¿ƒè€…ï¼ˆ1å¹´æœªæº€ï¼‰</option>
                                <option value="intermediate">ä¸­ç´šè€…ï¼ˆ1-3å¹´ï¼‰</option>
                                <option value="advanced">ãƒ™ãƒ†ãƒ©ãƒ³ï¼ˆ3å¹´ä»¥ä¸Šï¼‰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">å®Ÿç¸¾</label>
                            <input type="text" class="form-control" id="achievements" 
                                   placeholder="ä¾‹: 200å›ä»¥ä¸Šã®ãƒ„ã‚¢ãƒ¼å®Ÿç¸¾">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">å¾—æ„åˆ†é‡</label>
                        <div id="specialtiesContainer">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_culture" value="æ–‡åŒ–ãƒ»æ­´å²ã‚¬ã‚¤ãƒ‰">
                                <label class="form-check-label" for="spec_culture">æ–‡åŒ–ãƒ»æ­´å²</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_food" value="ã‚°ãƒ«ãƒ¡ã‚¬ã‚¤ãƒ‰">
                                <label class="form-check-label" for="spec_food">ã‚°ãƒ«ãƒ¡</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_nature" value="è‡ªç„¶ã‚¬ã‚¤ãƒ‰">
                                <label class="form-check-label" for="spec_nature">è‡ªç„¶ãƒ»ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_shopping" value="ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°">
                                <label class="form-check-label" for="spec_shopping">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="spec_photo" value="å†™çœŸæ’®å½±">
                                <label class="form-check-label" for="spec_photo">å†™çœŸæ’®å½±</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ„ã‚¢ãƒ¼å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-images me-2"></i>ãƒ„ã‚¢ãƒ¼å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼</h4>
                </div>
                <div class="p-3">
                    <div id="galleryPreview" class="mb-3">
                        <!-- ãƒ„ã‚¢ãƒ¼å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                    </div>
                    <input type="file" id="galleryInput" class="d-none" accept="image/*" multiple>
                    <button class="btn edit-btn" onclick="document.getElementById('galleryInput').click()">
                        <i class="bi bi-plus-circle me-2"></i>å†™çœŸã‚’è¿½åŠ 
                    </button>
                    <small class="text-muted d-block mt-2">æœ€å¤§6æšã¾ã§è¿½åŠ ã§ãã¾ã™</small>
                </div>
            </div>

            <!-- é€£çµ¡å…ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-envelope me-2"></i>é€£çµ¡å…ˆæƒ…å ±</h4>
                </div>
                <div class="p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" class="form-control" id="email" readonly>
                            <small class="text-muted">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">é›»è©±ç•ªå·</label>
                            <input type="tel" class="form-control" id="phone" readonly>
                            <small class="text-muted">é›»è©±ç•ªå·ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">å¯¾å¿œå¯èƒ½æ™‚é–“</label>
                        <input type="text" class="form-control" id="availability" 
                               placeholder="ä¾‹: 9:00 - 18:00">
                    </div>
                </div>
            </div>

            <!-- ãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-clock-history me-2"></i>å¯¾å¿œãƒãƒªã‚·ãƒ¼</h4>
                </div>
                <div class="p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">å»¶é•·å¯¾å¿œ</label>
                            <select class="form-control" id="extensionPolicy">
                                <option value="CONSULT">è¦ç›¸è«‡</option>
                                <option value="OK">å»¶é•·OK</option>
                                <option value="NG">å»¶é•·ä¸å¯</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">æ·±å¤œå¯¾å¿œï¼ˆ22æ™‚ä»¥é™ï¼‰</label>
                            <select class="form-control" id="lateNightPolicy">
                                <option value="no">æ·±å¤œå¯¾å¿œä¸å¯</option>
                                <option value="ok">æ·±å¤œå¯¾å¿œOK</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿è­¦å‘Š (å‹•çš„è¡¨ç¤º) -->
            <div id="incompleteDataWarning" class="alert alert-warning d-none" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>æ³¨æ„ï¼š</strong> ã“ã®ã‚¬ã‚¤ãƒ‰æƒ…å ±ã¯ä¸å®Œå…¨ã§ã™ã€‚ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
                <ul id="incompleteFieldsList" class="mb-0 mt-2"></ul>
            </div>

            <!-- ãã®ä»–ã®æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card p-3">
                <div class="section-header">
                    <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>ãã®ä»–ã®æƒ…å ±</h4>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="multiLingual">
                                <label class="form-check-label" for="multiLingual">å¤šè¨€èªå¯¾å¿œ</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hospitalitySupport">
                                <label class="form-check-label" for="hospitalitySupport">ãƒ›ã‚¹ãƒ”ã‚¿ãƒªãƒ†ã‚£é‡è¦–</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emergencySupport">
                                <label class="form-check-label" for="emergencySupport">ç·Šæ€¥æ™‚ã‚µãƒãƒ¼ãƒˆ</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localExpert">
                                <label class="form-check-label" for="localExpert">åœ°å…ƒå¯†ç€ã‚¬ã‚¤ãƒ‰</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
            <div class="text-center mt-4">
                <button type="button" class="btn save-btn me-3" id="saveChanges">
                    <i class="bi bi-check-circle me-2"></i>å¤‰æ›´ã‚’ä¿å­˜
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-x-circle me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>ã‚¬ã‚¤ãƒ‰æƒ…å ±ã‚’ä¿å­˜ä¸­...</h5>
                    <p class="text-muted mb-0">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentGuideId = null;
        
        // URLã‹ã‚‰ guide ID ã‚’å–å¾— (ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¿½åŠ )
        console.log('ğŸ” Current URL:', window.location.href);
        console.log('ğŸ” Search params:', window.location.search);
        
        const urlParams = new URLSearchParams(window.location.search);
        currentGuideId = urlParams.get('id');
        
        console.log('ğŸ” Extracted guide ID:', currentGuideId);
        console.log('ğŸ” All URL params:', Object.fromEntries(urlParams));
        
        if (!currentGuideId || currentGuideId.trim() === '') {
            console.error('âŒ No guide ID found in URL parameters');
            alert('ã‚¬ã‚¤ãƒ‰IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nURL: ' + window.location.href);
            window.location.href = 'index.html';
        } else {
            console.log('âœ… Guide ID validated:', currentGuideId);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¬ã‚¤ãƒ‰æƒ…å ±ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', async function() {
            await loadGuideData();
            setupEventListeners();
        });

        // ã‚¬ã‚¤ãƒ‰æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        async function loadGuideData() {
            try {
                console.log('ğŸ” Loading guide data for ID:', currentGuideId);
                const response = await fetch(`/api/guides/${currentGuideId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ğŸ“¥ API Response:', result);
                
                if (result.success && result.guide) {
                    console.log('âœ… Guide data loaded successfully');
                    populateForm(result.guide);
                } else {
                    console.error('âŒ Failed to get guide data:', result);
                    alert('ã‚¬ã‚¤ãƒ‰æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('âŒ Error loading guide data:', error);
                alert('ã‚¬ã‚¤ãƒ‰æƒ…å ±ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                window.location.href = 'index.html';
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
        function populateForm(guide) {
            // âœ… [EDIT LOAD LOG] Log normalized data
            console.log('ğŸ“‹ [EDIT] Loading guide data:', JSON.stringify({
                id: guide.id,
                name: guide.name || guide.guideName,
                price: guide.price || guide.guideSessionRate,
                isPublished: guide.isPublished
            }, null, 2));
            
            // Normalize field names (handle both canonical and legacy formats)
            const name = guide.name || guide.guideName || '';
            const price = guide.price || guide.guideSessionRate || '';
            const area = guide.area || guide.location || '';
            const description = guide.description || guide.guideIntroduction || guide.introduction || '';
            
            document.getElementById('guideName').value = name;
            document.getElementById('dailyRate').value = price;
            document.getElementById('location').value = area || 'äº¬éƒ½åºœ äº¬éƒ½å¸‚';
            document.getElementById('guideType').value = guide.guideType || 'day';
            document.getElementById('introduction').value = description;
            document.getElementById('experience').value = guide.guideExperience || guide.experience || 'intermediate';
            document.getElementById('achievements').value = guide.achievements || '';
            document.getElementById('email').value = guide.email || guide.guideEmail || '';
            document.getElementById('phone').value = guide.phone || guide.phoneNumber || '';
            document.getElementById('availability').value = guide.guideAvailability || guide.availability || '';
            
            // âœ… Policy fields
            document.getElementById('extensionPolicy').value = guide.extensionPolicy || 'CONSULT';
            document.getElementById('lateNightPolicy').value = guide.lateNightPolicy || 'no';
            
            // âœ… Check for incomplete data and show warning
            const incompleteFields = [];
            if (!name || name.trim() === '') incompleteFields.push('ã‚¬ã‚¤ãƒ‰å');
            if (!price || parseFloat(price) <= 0) incompleteFields.push('æ–™é‡‘');
            
            if (incompleteFields.length > 0) {
                const warningDiv = document.getElementById('incompleteDataWarning');
                const fieldsList = document.getElementById('incompleteFieldsList');
                fieldsList.innerHTML = incompleteFields.map(f => `<li>${f}</li>`).join('');
                warningDiv.classList.remove('d-none');
                console.warn('âš ï¸ [EDIT] Incomplete guide data detected:', incompleteFields);
            }
            
            // å¯¾å¿œè¨€èªã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š
            if (guide.guideLanguages && Array.isArray(guide.guideLanguages)) {
                const languageMap = {
                    'æ—¥æœ¬èª': 'lang_japanese',
                    'è‹±èª': 'lang_english',
                    'ä¸­å›½èª': 'lang_chinese',
                    'éŸ“å›½èª': 'lang_korean',
                    'å°æ¹¾èª': 'lang_taiwanese'
                };
                
                guide.guideLanguages.forEach(lang => {
                    const checkbox = document.getElementById(languageMap[lang]);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // å¾—æ„åˆ†é‡ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š
            if (guide.guideSpecialties) {
                const specialties = guide.guideSpecialties.split(',').map(s => s.trim());
                const specialtyMap = {
                    'æ–‡åŒ–ãƒ»æ­´å²ã‚¬ã‚¤ãƒ‰': 'spec_culture',
                    'ã‚°ãƒ«ãƒ¡ã‚¬ã‚¤ãƒ‰': 'spec_food', 
                    'è‡ªç„¶ã‚¬ã‚¤ãƒ‰': 'spec_nature',
                    'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°': 'spec_shopping',
                    'å†™çœŸæ’®å½±': 'spec_photo'
                };
                
                specialties.forEach(spec => {
                    const checkbox = document.getElementById(specialtyMap[spec]);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸè¨­å®š
            if (guide.profilePhoto && guide.profilePhoto.fileName) {
                document.getElementById('profilePhotoPreview').src = `/uploads/${guide.profilePhoto.fileName}`;
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupEventListeners() {
            // ä¿å­˜ãƒœã‚¿ãƒ³
            document.getElementById('saveChanges').addEventListener('click', saveGuideData);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
            document.getElementById('profilePhotoInput').addEventListener('change', handleProfilePhotoChange);
            document.getElementById('galleryInput').addEventListener('change', handleGalleryChange);
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸå¤‰æ›´å‡¦ç†
        function handleProfilePhotoChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼å†™çœŸè¿½åŠ å‡¦ç†
        function handleGalleryChange(event) {
            const files = Array.from(event.target.files);
            const galleryPreview = document.getElementById('galleryPreview');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    img.onclick = function() { this.remove(); };
                    galleryPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // ã‚¬ã‚¤ãƒ‰æƒ…å ±ä¿å­˜
        async function saveGuideData() {
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
            const formData = collectFormData();
            
            // âœ… [VALIDATION] Validate before saving
            const validation = validateFormData(formData);
            if (!validation.valid) {
                showToast(validation.errors.join('ã€'), 'error');
                return;
            }
            
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            try {
                const response = await fetch(`/api/guides/${currentGuideId}/edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadingModal.hide();
                    showToast('ã‚¬ã‚¤ãƒ‰æƒ…å ±ã‚’æ­£å¸¸ã«æ›´æ–°ã—ã¾ã—ãŸï¼', 'success');
                    
                    // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°æƒ…å ±ã‚’åæ˜ 
                    if (window.opener) {
                        // Send message to parent window to trigger refresh
                        try {
                            window.opener.postMessage({
                                type: 'guideUpdated',
                                guideId: currentGuideId,
                                action: 'edit',
                                message: 'ã‚¬ã‚¤ãƒ‰æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼'
                            }, '*');
                            console.log('âœ… Update message sent to parent window');
                        } catch (messageError) {
                            console.warn('âš ï¸ Failed to send message to parent:', messageError);
                        }
                        
                        // Use the global refresh function if available
                        if (window.opener.refreshGuideData) {
                            await window.opener.refreshGuideData();
                        } else {
                            window.opener.location.reload();
                        }
                        
                        // Show success notification in parent window
                        if (window.opener.showNewGuideNotification) {
                            window.opener.showNewGuideNotification(1, false, 'ã‚¬ã‚¤ãƒ‰æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
                        }
                    }
                    
                    // è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆã‚¬ã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼‰ã«æˆ»ã‚‹
                    setTimeout(() => {
                        console.log('âœ… ã‚¬ã‚¤ãƒ‰ç·¨é›†å®Œäº† - è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™');
                        if (window.opener) {
                            window.close();
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1500);
                    
                } else {
                    throw new Error(result.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                loadingModal.hide();
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            // é¸æŠã•ã‚ŒãŸè¨€èªã‚’åé›†
            const selectedLanguages = [];
            const languageCheckboxes = document.querySelectorAll('#languagesContainer input[type="checkbox"]:checked');
            languageCheckboxes.forEach(cb => selectedLanguages.push(cb.value));
            
            // é¸æŠã•ã‚ŒãŸå¾—æ„åˆ†é‡ã‚’åé›†
            const selectedSpecialties = [];
            const specialtyCheckboxes = document.querySelectorAll('#specialtiesContainer input[type="checkbox"]:checked');
            specialtyCheckboxes.forEach(cb => selectedSpecialties.push(cb.value));
            
            return {
                guideName: document.getElementById('guideName').value,
                guideSessionRate: document.getElementById('dailyRate').value,
                location: document.getElementById('location').value,
                guideType: document.getElementById('guideType').value,
                guideLanguages: selectedLanguages,
                guideIntroduction: document.getElementById('introduction').value,
                guideExperience: document.getElementById('experience').value,
                achievements: document.getElementById('achievements').value,
                guideSpecialties: selectedSpecialties.join(', '),
                guideAvailability: document.getElementById('availability').value,
                // âœ… Policy fields
                extensionPolicy: document.getElementById('extensionPolicy').value,
                lateNightPolicy: document.getElementById('lateNightPolicy').value,
                multiLingual: document.getElementById('multiLingual').checked,
                hospitalitySupport: document.getElementById('hospitalitySupport').checked,
                emergencySupport: document.getElementById('emergencySupport').checked,
                localExpert: document.getElementById('localExpert').checked
            };
        }
        
        // âœ… [VALIDATION] Validate form data before save
        function validateFormData(formData) {
            const errors = [];
            
            if (!formData.guideName || formData.guideName.trim() === '') {
                errors.push('ã‚¬ã‚¤ãƒ‰åã¯å¿…é ˆã§ã™');
            }
            
            const price = parseFloat(formData.guideSessionRate);
            if (!price || price <= 0) {
                errors.push('æ–™é‡‘ã¯1ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        // Toasté€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        function showToast(message, type = 'success') {
            const toastHtml = `
                <div class="toast-container position-fixed top-0 end-0 p-3">
                    <div class="toast show" role="alert">
                        <div class="toast-header">
                            <i class="bi bi-${type === 'success' ? 'check-circle-fill text-success' : 'exclamation-triangle-fill text-danger'} me-2"></i>
                            <strong class="me-auto">TomoTrip</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(() => {
                const toastElement = document.querySelector('.toast-container');
                if (toastElement) toastElement.remove();
            }, 3000);
        }
    </script>
</body>
</html>