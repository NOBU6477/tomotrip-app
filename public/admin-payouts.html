<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>TomoTrip - é…å½“ç®¡ç†ï¼ˆAdminï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f0f2f5; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; }
        .sidebar { width: 220px; min-height: 100vh; background: #1a1a2e; color: #fff; position: fixed; left: 0; top: 0; z-index: 100; }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; border-radius: 0; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
        .main-content { margin-left: 220px; padding: 20px; }
        .tab-section { display: none; }
        .tab-section.active { display: block; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .btn-run { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; }
        .btn-run:hover { background: linear-gradient(135deg, #5a6fd6, #6a4299); color: #fff; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; min-height: auto; position: relative; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background:rgba(0,0,0,0.5);z-index:9999;">
        <div class="card p-4" style="width:360px;">
            <h5 class="mb-3 text-center">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h5>
            <input type="text" id="loginUser" class="form-control mb-2" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
            <input type="password" id="loginPass" class="form-control mb-3" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button class="btn btn-primary w-100" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="loginError" class="text-danger small mt-2 d-none"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="p-3 border-bottom border-secondary">
            <strong><i class="bi bi-cash-coin me-1"></i> é…å½“ç®¡ç†</strong>
        </div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" data-tab="founders" href="#"><i class="bi bi-link-45deg me-2"></i>æ°¸ç¶šé…å½“ ç´ä»˜ã‘</a>
            <a class="nav-link" data-tab="contributions" href="#"><i class="bi bi-journal-plus me-2"></i>è²¢çŒ®ãƒ­ã‚°</a>
            <a class="nav-link" data-tab="monthly" href="#"><i class="bi bi-calculator me-2"></i>æœˆæ¬¡å‡¦ç†</a>
            <a class="nav-link" data-tab="results" href="#"><i class="bi bi-table me-2"></i>é…å½“çµæœ</a>
            <a class="nav-link" data-tab="guides" href="#"><i class="bi bi-person-badge me-2"></i>ã‚¬ã‚¤ãƒ‰ç®¡ç†</a>
            <a class="nav-link" data-tab="settings" href="#"><i class="bi bi-gear me-2"></i>è¨­å®šç®¡ç†</a>
        </nav>
        <div class="p-3 mt-auto border-top border-secondary">
            <a href="/" class="text-white-50 small"><i class="bi bi-arrow-left me-1"></i>ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <div class="main-content">
        <div id="tab-founders" class="tab-section active">
            <h4 class="mb-3">æ°¸ç¶šé…å½“ ç´ä»˜ã‘ç®¡ç†</h4>
            <div class="card p-3 mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small">åº—èˆ—</label>
                        <select id="founderStoreSelect" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">ã‚¬ã‚¤ãƒ‰ï¼ˆFounderï¼‰</label>
                        <select id="founderGuideSelect" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary btn-sm" onclick="assignFounder()">ç´ä»˜ã‘ç™»éŒ²</button>
                    </div>
                </div>
            </div>
            <div class="card p-3">
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>åº—èˆ—</th><th>Founder ã‚¬ã‚¤ãƒ‰</th><th>è¨­å®šæ—¥</th><th></th></tr></thead>
                    <tbody id="foundersTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-contributions" class="tab-section">
            <h4 class="mb-3">è²¢çŒ®ãƒ­ã‚°ç®¡ç†</h4>
            <div class="card p-3 mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small">æœˆ</label>
                        <input type="month" id="contribMonth" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">åº—èˆ—</label>
                        <select id="contribStoreSelect" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">ã‚¬ã‚¤ãƒ‰</label>
                        <select id="contribGuideSelect" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">ç¨®é¡</label>
                        <select id="contribType" class="form-select form-select-sm">
                            <option value="A">A: é€å®¢ (5pt)</option>
                            <option value="B">B: åˆ©ç”¨ (2pt)</option>
                            <option value="C">C: æ‹¡æ•£ (1pt)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">è¨¼è·¡URL</label>
                        <input type="text" id="contribEvidence" class="form-control form-control-sm" placeholder="ä»»æ„">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-primary btn-sm w-100" onclick="addContribution()">è¿½åŠ </button>
                    </div>
                </div>
            </div>
            <div class="card p-3 mb-3">
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-auto">
                        <input type="month" id="contribFilterMonth" class="form-control form-control-sm" onchange="loadContributions()">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadContributions()">ãƒ•ã‚£ãƒ«ã‚¿</button>
                    </div>
                </div>
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>æœˆ</th><th>åº—èˆ—</th><th>ã‚¬ã‚¤ãƒ‰</th><th>ç¨®é¡</th><th>Pts</th><th>è¨¼è·¡</th><th></th></tr></thead>
                    <tbody id="contribTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-monthly" class="tab-section">
            <h4 class="mb-3">æœˆæ¬¡å‡¦ç†</h4>
            <div class="card p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">å¯¾è±¡æœˆ</label>
                        <input type="month" id="runMonth" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-run btn-lg" onclick="runMonthly()">
                            <i class="bi bi-play-circle me-1"></i> æœˆæ¬¡è¨ˆç®—ã‚’å®Ÿè¡Œ
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning btn-sm" onclick="unlockMonth()">
                            <i class="bi bi-unlock me-1"></i> ãƒ­ãƒƒã‚¯è§£é™¤
                        </button>
                    </div>
                </div>
                <div id="runResult" class="mt-3 d-none">
                    <div class="alert alert-success" id="runResultContent"></div>
                </div>
            </div>
            <div class="card p-3 mt-3">
                <h6>ãƒ©ãƒ³ã‚¯ãƒ»ã‚¹ã‚³ã‚¢ä¸€è¦§</h6>
                <div class="row g-2 mb-2">
                    <div class="col-auto">
                        <input type="month" id="scoresMonth" class="form-control form-control-sm" onchange="loadScores()">
                    </div>
                </div>
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>ã‚¬ã‚¤ãƒ‰ID</th><th>æœˆé–“Score</th><th>3ãƒ¶æœˆå¹³å‡</th><th>ãƒ©ãƒ³ã‚¯Score</th><th>ãƒ©ãƒ³ã‚¯</th><th>ãƒ­ãƒƒã‚¯</th></tr></thead>
                    <tbody id="scoresTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-results" class="tab-section">
            <h4 class="mb-3">é…å½“çµæœ</h4>
            <div class="card p-3">
                <div class="row g-2 mb-3">
                    <div class="col-auto">
                        <input type="month" id="resultsMonth" class="form-control form-control-sm" onchange="loadResults()">
                    </div>
                </div>
                <table class="table table-sm table-hover mb-0">
                    <thead><tr><th>ã‚¬ã‚¤ãƒ‰</th><th>åº—èˆ—</th><th>ç¨®é¡</th><th>é‡‘é¡</th><th>è©³ç´°</th></tr></thead>
                    <tbody id="resultsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-guides" class="tab-section">
            <h4 class="mb-3">ã‚¬ã‚¤ãƒ‰ç®¡ç†ï¼ˆè¨€èªãƒ»é€£çµ¡å…ˆãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ï¼‰</h4>
            <div class="card p-3 mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label small">ã‚¬ã‚¤ãƒ‰é¸æŠ</label>
                        <select id="guideProfileSelect" class="form-select form-select-sm" onchange="loadGuideProfile()"></select>
                    </div>
                </div>
            </div>
            <div id="guideProfilePanel" class="d-none">
                <div class="card p-3 mb-3">
                    <h6 class="mb-3"><i class="bi bi-person me-1"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">è¡¨ç¤ºè¨€èª (preferred_language)</label>
                            <select id="gpLang" class="form-select form-select-sm">
                                <option value="ja">æ—¥æœ¬èª (ja)</option>
                                <option value="en">English (en)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">é€£çµ¡æ–¹æ³• (contact_method)</label>
                            <select id="gpContact" class="form-select form-select-sm">
                                <option value="line">LINE</option>
                                <option value="email">Email</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="gpEmail" class="form-control form-control-sm" placeholder="guide@example.com">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm mt-3" onclick="saveGuideProfile()">
                        <i class="bi bi-save me-1"></i>ä¿å­˜
                    </button>
                </div>
                <div class="card p-3 mb-3">
                    <h6 class="mb-3"><i class="bi bi-link-45deg me-1"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒªãƒ³ã‚¯</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text small">URL</span>
                        <input type="text" id="gpDashboardUrl" class="form-control form-control-sm" readonly>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyDashboardUrl()">
                            <i class="bi bi-clipboard"></i> ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-warning btn-sm" onclick="regenerateKey()">
                            <i class="bi bi-arrow-repeat me-1"></i>ãƒªãƒ³ã‚¯ã‚’å†ç™ºè¡Œï¼ˆæ—§ãƒªãƒ³ã‚¯ç„¡åŠ¹åŒ–ï¼‰
                        </button>
                        <small class="text-muted">å†ç™ºè¡Œã™ã‚‹ã¨ä»¥å‰ã®ãƒªãƒ³ã‚¯ã¯ä½¿ãˆãªããªã‚Šã¾ã™</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-section">
            <h4 class="mb-3">è¨­å®šç®¡ç†</h4>
            <div id="settingsContainer"></div>
            <button class="btn btn-primary mt-3" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let TOKEN = localStorage.getItem('admin_token') || '';
    const typeLabels = { A: 'é€å®¢', B: 'åˆ©ç”¨', C: 'æ‹¡æ•£' };

    if (TOKEN) {
        document.getElementById('loginOverlay').classList.add('d-none');
        initApp();
    }

    async function doLogin() {
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;
        try {
            const res = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass, accessLevel: 'operator' })
            });
            const data = await res.json();
            if (data.success && data.token) {
                TOKEN = data.token;
                localStorage.setItem('admin_token', TOKEN);
                document.getElementById('loginOverlay').classList.add('d-none');
                initApp();
            } else {
                document.getElementById('loginError').textContent = data.message || 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—';
                document.getElementById('loginError').classList.remove('d-none');
            }
        } catch(e) {
            document.getElementById('loginError').textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼';
            document.getElementById('loginError').classList.remove('d-none');
        }
    }

    function authHeaders() {
        return { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json' };
    }

    async function adminFetch(url, opts = {}) {
        opts.headers = { ...authHeaders(), ...(opts.headers || {}) };
        const res = await fetch(url, opts);
        if (res.status === 401) {
            TOKEN = '';
            localStorage.removeItem('admin_token');
            location.reload();
            return;
        }
        return res.json();
    }

    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + link.dataset.tab).classList.add('active');
        });
    });

    const curMonth = new Date().getFullYear() + '-' + String(new Date().getMonth()+1).padStart(2,'0');

    async function initApp() {
        document.getElementById('contribMonth').value = curMonth;
        document.getElementById('contribFilterMonth').value = curMonth;
        document.getElementById('runMonth').value = curMonth;
        document.getElementById('scoresMonth').value = curMonth;
        document.getElementById('resultsMonth').value = curMonth;
        await Promise.all([loadSelects(), loadFounders(), loadContributions(), loadSettings()]);
    }

    let allGuidesCache = [];

    async function loadSelects() {
        const [stores, guides] = await Promise.all([
            adminFetch('/api/admin/payout-stores-list'),
            adminFetch('/api/admin/payout-guides-list')
        ]);
        allGuidesCache = guides || [];
        const storeSelects = ['founderStoreSelect', 'contribStoreSelect'];
        const guideSelects = ['founderGuideSelect', 'contribGuideSelect'];
        storeSelects.forEach(id => {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">é¸æŠ...</option>';
            (stores||[]).forEach(s => {
                const o = document.createElement('option');
                o.value = s.id; o.textContent = s.store_name || s.id;
                sel.appendChild(o);
            });
        });
        guideSelects.forEach(id => {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">é¸æŠ...</option>';
            (guides||[]).forEach(g => {
                const o = document.createElement('option');
                o.value = g.id; o.textContent = g.guide_name || g.id;
                sel.appendChild(o);
            });
        });
        const gpSel = document.getElementById('guideProfileSelect');
        gpSel.innerHTML = '<option value="">ã‚¬ã‚¤ãƒ‰ã‚’é¸æŠ...</option>';
        (guides||[]).forEach(g => {
            const o = document.createElement('option');
            o.value = g.id;
            o.textContent = (g.guide_name || g.id) + ' [' + (g.preferred_language||'ja') + '/' + (g.contact_method||'line') + ']';
            gpSel.appendChild(o);
        });
    }

    async function loadFounders() {
        const data = await adminFetch('/api/admin/payout-founders');
        const tb = document.getElementById('foundersTable');
        if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="4" class="text-muted text-center">ç´ä»˜ã‘ãªã—</td></tr>';
            return;
        }
        tb.innerHTML = data.map(f =>
            '<tr><td>' + (f.store_name||f.store_id) + '</td><td>' + (f.guide_name||f.guide_id) + '</td><td>' + new Date(f.assigned_at).toLocaleDateString('ja') + '</td><td><button class="btn btn-outline-danger btn-sm" onclick="removeFounder(\'' + f.store_id + '\')">å‰Šé™¤</button></td></tr>'
        ).join('');
    }

    async function assignFounder() {
        const storeId = document.getElementById('founderStoreSelect').value;
        const guideId = document.getElementById('founderGuideSelect').value;
        if (!storeId || !guideId) return alert('åº—èˆ—ã¨ã‚¬ã‚¤ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
        const result = await adminFetch('/api/admin/payout-founders', {
            method: 'POST', body: JSON.stringify({ store_id: storeId, guide_id: guideId })
        });
        if (result?.error) return alert(result.error);
        loadFounders();
    }

    async function removeFounder(storeId) {
        if (!confirm('ã“ã®ç´ä»˜ã‘ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        await adminFetch('/api/admin/payout-founders/' + storeId, { method: 'DELETE' });
        loadFounders();
    }

    async function loadContributions() {
        const month = document.getElementById('contribFilterMonth').value;
        const data = await adminFetch('/api/admin/payout-contributions?month=' + month);
        const tb = document.getElementById('contribTable');
        if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="7" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
            return;
        }
        tb.innerHTML = data.map(c =>
            '<tr><td>' + c.month + '</td><td>' + (c.store_name||c.store_id) + '</td><td>' + (c.guide_name||c.guide_id) + '</td><td><span class="badge bg-' + ({A:'danger',B:'warning',C:'success'}[c.type]) + '">' + (typeLabels[c.type]||c.type) + '</span></td><td>' + c.base_points + '</td><td>' + (c.evidence_url ? '<a href="'+c.evidence_url+'" target="_blank">link</a>' : '-') + '</td><td><button class="btn btn-outline-danger btn-sm" onclick="deleteContrib('+c.id+')">å‰Šé™¤</button></td></tr>'
        ).join('');
    }

    async function addContribution() {
        const month = document.getElementById('contribMonth').value.slice(0,7);
        const data = {
            store_id: document.getElementById('contribStoreSelect').value,
            guide_id: document.getElementById('contribGuideSelect').value,
            month: month,
            type: document.getElementById('contribType').value,
            evidence_url: document.getElementById('contribEvidence').value
        };
        if (!data.store_id || !data.guide_id || !data.month) return alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        const result = await adminFetch('/api/admin/payout-contributions', {
            method: 'POST', body: JSON.stringify(data)
        });
        if (result?.error) return alert(result.error);
        loadContributions();
    }

    async function deleteContrib(id) {
        if (!confirm('ã“ã®è²¢çŒ®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        await adminFetch('/api/admin/payout-contributions/' + id, { method: 'DELETE' });
        loadContributions();
    }

    async function runMonthly() {
        const month = document.getElementById('runMonth').value.slice(0,7);
        if (!month) return alert('æœˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
        if (!confirm(month + ' ã®æœˆæ¬¡è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
        const result = await adminFetch('/api/admin/run-monthly', {
            method: 'POST', body: JSON.stringify({ month })
        });
        const el = document.getElementById('runResult');
        const content = document.getElementById('runResultContent');
        el.classList.remove('d-none');
        if (result?.error) {
            content.className = 'alert alert-danger';
            content.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + result.error;
        } else {
            content.className = 'alert alert-success';
            content.textContent = 'å®Œäº†ï¼ å¯¾è±¡ã‚¬ã‚¤ãƒ‰: ' + result.guides_scored + 'å / æ°¸ç¶šé…å½“: Â¥' + (result.perpetual_total||0).toLocaleString() + ' / è²¢çŒ®é…å½“: Â¥' + (result.contrib_total||0).toLocaleString() + ' / åˆè¨ˆ: Â¥' + (result.grand_total||0).toLocaleString();
        }
        loadScores();
    }

    async function unlockMonth() {
        const month = document.getElementById('runMonth').value.slice(0,7);
        if (!month) return alert('æœˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
        if (!confirm(month + ' ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        await adminFetch('/api/admin/unlock-month', { method: 'POST', body: JSON.stringify({ month }) });
        alert('ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ');
        loadScores();
    }

    async function loadScores() {
        const month = document.getElementById('scoresMonth').value.slice(0,7);
        const data = await adminFetch('/api/admin/payout-scores?month=' + month);
        const tb = document.getElementById('scoresTable');
        if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="6" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
            return;
        }
        tb.innerHTML = data.map(s =>
            '<tr><td class="small">' + s.guide_id.slice(0,8) + '...</td><td>' + Number(s.monthly_score).toFixed(1) + '</td><td>' + Number(s.avg3_score).toFixed(1) + '</td><td>' + Number(s.rank_score).toFixed(1) + '</td><td><span class="badge bg-' + ({S:'warning',A:'primary',B:'info',C:'secondary'}[s.rank]) + '">' + s.rank + '</span></td><td>' + (s.locked ? 'ğŸ”’' : '-') + '</td></tr>'
        ).join('');
    }

    async function loadResults() {
        const month = document.getElementById('resultsMonth').value.slice(0,7);
        const data = await adminFetch('/api/admin/payout-results?month=' + month);
        const tb = document.getElementById('resultsTable');
        if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="5" class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
            return;
        }
        tb.innerHTML = data.map(p => {
            const det = p.details_json || {};
            return '<tr><td>' + (p.guide_name||p.guide_id.slice(0,8)) + '</td><td>' + (p.store_name||p.store_id.slice(0,8)) + '</td><td><span class="badge bg-' + (p.type==='PERPETUAL'?'success':'primary') + '">' + (p.type==='PERPETUAL'?'æ°¸ç¶š':'è²¢çŒ®') + '</span></td><td class="fw-bold">Â¥' + p.amount.toLocaleString() + '</td><td class="small text-muted">' + (det.multiplier ? 'x'+det.multiplier : det.reason||'') + '</td></tr>';
        }).join('');
    }

    async function loadSettings() {
        const data = await adminFetch('/api/admin/payout-settings');
        const container = document.getElementById('settingsContainer');
        if (!data) return;
        container.innerHTML = Object.entries(data).map(([key, val]) =>
            '<div class="card p-3 mb-2"><label class="form-label fw-bold">' + key + '</label><textarea class="form-control form-control-sm" data-key="' + key + '" rows="3">' + JSON.stringify(val, null, 2) + '</textarea></div>'
        ).join('');
    }

    async function saveSettings() {
        const areas = document.querySelectorAll('#settingsContainer textarea');
        for (const area of areas) {
            try {
                const val = JSON.parse(area.value);
                await adminFetch('/api/admin/payout-settings/' + area.dataset.key, {
                    method: 'PUT', body: JSON.stringify({ value: val })
                });
            } catch(e) {
                alert(area.dataset.key + ' ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }
        }
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    let currentGuideId = null;

    async function loadGuideProfile() {
        const guideId = document.getElementById('guideProfileSelect').value;
        const panel = document.getElementById('guideProfilePanel');
        if (!guideId) { panel.classList.add('d-none'); return; }
        currentGuideId = guideId;
        const cached = allGuidesCache.find(g => g.id === guideId);
        if (cached) {
            document.getElementById('gpLang').value = cached.preferred_language || 'ja';
            document.getElementById('gpContact').value = cached.contact_method || 'line';
            document.getElementById('gpEmail').value = cached.email || '';
            updateDashboardUrl(cached.dashboard_key);
        }
        panel.classList.remove('d-none');
    }

    function updateDashboardUrl(key) {
        const base = location.origin + '/guide-payouts.html?k=' + (key || '');
        document.getElementById('gpDashboardUrl').value = base;
    }

    async function saveGuideProfile() {
        if (!currentGuideId) return;
        const data = {
            preferred_language: document.getElementById('gpLang').value,
            contact_method: document.getElementById('gpContact').value,
            email: document.getElementById('gpEmail').value
        };
        const result = await adminFetch('/api/admin/guide-profile/' + currentGuideId, {
            method: 'PUT', body: JSON.stringify(data)
        });
        if (result?.error) return alert(result.error);
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        await loadSelects();
        document.getElementById('guideProfileSelect').value = currentGuideId;
    }

    async function regenerateKey() {
        if (!currentGuideId) return;
        if (!confirm('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’å†ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ\nä»¥å‰ã®ãƒªãƒ³ã‚¯ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚')) return;
        const result = await adminFetch('/api/admin/guide-dashboard-key/' + currentGuideId, {
            method: 'POST'
        });
        if (result?.error) return alert(result.error);
        updateDashboardUrl(result.dashboard_key);
        alert('ãƒªãƒ³ã‚¯ã‚’å†ç™ºè¡Œã—ã¾ã—ãŸ');
        await loadSelects();
        document.getElementById('guideProfileSelect').value = currentGuideId;
    }

    function copyDashboardUrl() {
        const url = document.getElementById('gpDashboardUrl').value;
        navigator.clipboard.writeText(url).then(() => {
            alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }).catch(() => {
            const input = document.getElementById('gpDashboardUrl');
            input.select();
            document.execCommand('copy');
        });
    }
    </script>
</body>
</html>
